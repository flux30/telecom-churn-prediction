{% extends "base.html" %}

{% block title %}Predict - Telecom Churn Prediction{% endblock %}

{% block content %}
<div class="container">
    <!-- Page Header -->
    <div class="page-header">
        <h1 class="page-title">Churn Prediction</h1>
        <p class="page-subtitle">Evaluate dataset or predict custom cases</p>
    </div>

    <!-- Dataset Evaluation -->
    <section class="dataset-section glass-morphism">
        <h2>üìä Dataset Evaluation</h2>
        <p>Evaluate the entire customer dataset with your selected model</p>
        
        <div class="dataset-actions">
            <button class="btn btn-primary" onclick="evaluateDataset()">
                Evaluate Full Dataset
            </button>
            <select id="datasetModel" class="glass-morphism model-selector">
                <option value="best">Best Model (Auto-Select)</option>
                <option value="decision_tree">Decision Tree</option>
                <option value="knn">K-Nearest Neighbors</option>
            </select>
        </div>

        <div id="datasetResults" class="evaluation-results" style="display: none;">
            <h3>Evaluation Results</h3>
            <div class="stats-grid" style="margin: 1.5rem 0;">
                <div class="glass-card stat-card">
                    <div class="stat-value" id="totalEvaluated">0</div>
                    <div class="stat-label">Total Evaluated</div>
                </div>
                <div class="glass-card stat-card">
                    <div class="stat-value" id="predictedChurn">0</div>
                    <div class="stat-label">Predicted Churn</div>
                </div>
                <div class="glass-card stat-card">
                    <div class="stat-value" id="accuracy">0%</div>
                    <div class="stat-label">Accuracy</div>
                </div>
                <div class="glass-card stat-card">
                    <div class="stat-value" id="modelUsedDataset">-</div>
                    <div class="stat-label">Model Used</div>
                </div>
            </div>
            
            <h4 style="margin: 2rem 0 1rem;">Predictions:</h4>
            <div id="predictionsList" class="predictions-grid"></div>
        </div>
    </section>

    <!-- Custom Case Prediction - CENTERED -->
    <div class="predict-container">
        <div class="glass-card predict-form-container">
            <h2>üéØ Custom Case Prediction</h2>
            <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                Enter customer details for individual churn prediction
            </p>
            
            <form id="predictForm">
                <div class="form-group">
                    <label>Age</label>
                    <input type="number" name="age" min="18" max="100" required placeholder="25">
                </div>

                <div class="form-group">
                    <label>Monthly Spend (INR)</label>
                    <input type="number" name="monthly_spend" min="0" step="0.01" required placeholder="299">
                </div>

                <div class="form-group">
                    <label>Tenure (Months)</label>
                    <input type="number" name="tenure" min="0" required placeholder="6">
                </div>

                <div class="form-group">
                    <label>Recharge Type</label>
                    <select name="recharge_type" required>
                        <option value="">-- Select Recharge Type --</option>
                        <option value="0">Postpaid</option>
                        <option value="1">Postpaid (Corporate)</option>
                        <option value="2">Prepaid (28 Days)</option>
                        <option value="3">Prepaid (84 Days)</option>
                        <option value="4">Prepaid (Annual)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Data Usage (GB/Month)</label>
                    <input type="number" name="data_usage" min="0" step="0.1" required placeholder="12">
                </div>

                <div class="form-group">
                    <label>Complaints (Last 3 Months)</label>
                    <input type="number" name="complaints" min="0" required placeholder="2">
                </div>

                <div class="form-group">
                    <label>Select Model</label>
                    <select name="model_type" required>
                        <option value="">-- Select Model --</option>
                        <option value="best">Best Model (Auto-Select)</option>
                        <option value="decision_tree">Decision Tree</option>
                        <option value="knn">K-Nearest Neighbors</option>
                    </select>
                </div>

                <button type="submit" class="btn btn-primary btn-block">Predict Churn</button>
            </form>
        </div>

        <div class="glass-card predict-result-container" id="resultContainer" style="display: none;">
            <h2>Prediction Result</h2>
            
            <div class="result-status" id="resultStatus">
                <div class="status-icon" id="statusIcon">‚ùì</div>
                <div class="status-text" id="statusText">Awaiting prediction...</div>
            </div>

            <div class="result-details">
                <div class="result-item">
                    <span class="result-label">Model Used:</span>
                    <span class="result-value" id="modelUsed">-</span>
                </div>
                
                <div class="result-item">
                    <span class="result-label">Prediction:</span>
                    <span class="result-value" id="prediction">-</span>
                </div>
                
                <div class="result-item">
                    <span class="result-label">Probability:</span>
                    <span class="result-value" id="probability">-</span>
                </div>
                
                <div class="result-item">
                    <span class="result-label">Confidence:</span>
                    <span class="result-value" id="confidence">-</span>
                </div>
            </div>

            <div class="result-recommendation" id="recommendation"></div>
        </div>
    </div>
</div>

<script>
// Dataset Evaluation
async function evaluateDataset() {
    const modelSelect = document.getElementById('datasetModel').value;
    const resultsDiv = document.getElementById('datasetResults');
    
    console.log('Evaluating dataset with model:', modelSelect);
    
    try {
        const response = await fetch('/api/evaluate_dataset', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ model_type: modelSelect })
        });
        
        const data = await response.json();
        console.log('Evaluation response:', data);
        
        if (response.ok) {
            document.getElementById('totalEvaluated').textContent = data.total;
            document.getElementById('predictedChurn').textContent = data.churned;
            document.getElementById('accuracy').textContent = data.accuracy + '%';
            document.getElementById('modelUsedDataset').textContent = data.model_used;
            
            const predList = document.getElementById('predictionsList');
            predList.innerHTML = data.predictions.map(p => `
                <div class="prediction-row ${p.prediction === 'Churn' ? 'churn' : 'no-churn'}">
                    <span><strong>${p.customer_id}</strong></span>
                    <span>${p.prediction}</span>
                    <span>${(p.probability * 100).toFixed(1)}%</span>
                </div>
            `).join('');
            
            resultsDiv.style.display = 'block';
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        console.error('Evaluation error:', error);
        alert('Error evaluating dataset: ' + error);
    }
}

// Custom Case Prediction
document.getElementById('predictForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    
    const data = {
        age: formData.get('age'),
        monthly_spend: formData.get('monthly_spend'),
        tenure: formData.get('tenure'),
        recharge_type: formData.get('recharge_type'),
        data_usage: formData.get('data_usage'),
        complaints: formData.get('complaints'),
        model_type: formData.get('model_type')
    };
    
    console.log('Predicting with data:', data);
    
    try {
        const response = await fetch('/api/predict', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        console.log('Prediction response:', result);
        
        if (response.ok) {
            const resultContainer = document.getElementById('resultContainer');
            const isChurn = result.prediction === 'Churn';
            
            document.getElementById('statusIcon').textContent = isChurn ? '‚ö†Ô∏è' : '‚úÖ';
            document.getElementById('statusText').textContent = result.prediction;
            document.getElementById('statusText').style.color = isChurn ? '#EF4444' : '#10B981';
            
            document.getElementById('modelUsed').textContent = result.model_used;
            document.getElementById('prediction').textContent = result.prediction;
            document.getElementById('prediction').style.color = isChurn ? '#EF4444' : '#10B981';
            document.getElementById('probability').textContent = result.probability ? (result.probability * 100).toFixed(2) + '%' : 'N/A';
            document.getElementById('confidence').textContent = result.confidence;
            
            document.getElementById('recommendation').innerHTML = isChurn ?
                '<h4 style="color: #EF4444;">‚ö†Ô∏è High Churn Risk</h4><ul><li>Reach out proactively with retention offers</li><li>Address complaints immediately</li><li>Offer loyalty incentives</li></ul>' :
                '<h4 style="color: #10B981;">‚úÖ Low Churn Risk</h4><ul><li>Maintain service quality</li><li>Consider upselling premium features</li><li>Encourage referrals</li></ul>';
            
            resultContainer.style.display = 'block';
        } else {
            alert('Error: ' + result.error);
        }
    } catch (error) {
        console.error('Prediction error:', error);
        alert('Prediction error: ' + error);
    }
});
</script>
{% endblock %}
